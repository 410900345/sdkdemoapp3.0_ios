
## 环信红包接入文档(iOS)

#### 环信红包简介（此文档只针对非Demo版本的集成说明，仅做参考）
1. 为 APP 提供了完整的收发红包流程以及账户体系。

2. 环信官方`SDK2.2.9 ChatDemoUI3.0`版Demo已默认集成红包功能，可以直接下载试用。

3. 通过.pch文件中的宏定义`REDPACKET_AVALABLE`开启或者关闭红包功能。

#### SDK介绍
`RedpacketSDK`包含 `RedpacketStaticLib`  `RedpacketOpen` 和 `Alipay`

`RedpacketStaticLib`静态库提供，实现了红包收发流程和账号安全体系。 

`RedpacketOpen`开源方式提供，实现了红包消息的展示

`AliPay` 支付宝SDK


#### Step1. 导入SDK
 将红包库`RedpacketSDK`添加到工程里
 
 添加CoreMotion.framework,支付宝需要
 
 如果缺少其它的支付宝依赖库，还需依次添加

#### Step2. 配置商户ID
**@Class:** *AppDelegate*

**@description:** 配置红包AppKey，处理支付宝回调

```
- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions
{   
	//TODO:1 配置商户的AppKey
    [[RedPacketUserConfig sharedConfig] configWithAppKey:@"easemob-demo#chatdemoui"];
    
    ...
    ...
}

//  这版添加了支付宝，所以需要在此处理支付宝回调
 #ifdef REDPACKET_AVALABLE
 #pragma mark - Alipay

- (void)applicationDidBecomeActive:(UIApplication *)application
{
    [[NSNotificationCenter defaultCenter] postNotificationName:RedpacketAlipayNotifaction object:nil];
}

- (BOOL)application:(UIApplication *)application
            openURL:(NSURL *)url
  sourceApplication:(NSString *)sourceApplication
         annotation:(id)annotation {
    
    if ([url.host isEqualToString:@"safepay"]) {
        //跳转支付宝钱包进行支付，处理支付结果
        [[AlipaySDK defaultService] processOrderWithPaymentResult:url standbyCallback:^(NSDictionary *resultDic) {
            [[NSNotificationCenter defaultCenter] postNotificationName:RedpacketAlipayNotifaction object:resultDic];
        }];
    }
    return YES;
}

// NOTE: 9.0以后使用新API接口
- (BOOL)application:(UIApplication *)app
            openURL:(NSURL *)url
            options:(NSDictionary<NSString*, id> *)options
{
    if ([url.host isEqualToString:@"safepay"]) {
        //跳转支付宝钱包进行支付，处理支付结果
        [[AlipaySDK defaultService] processOrderWithPaymentResult:url standbyCallback:^(NSDictionary *resultDic) {
            [[NSNotificationCenter defaultCenter] postNotificationName:RedpacketAlipayNotifaction object:resultDic];
        }];
    }
    return YES;
}

 #endif

    
```

#### Step3. 公开协议

**@class:** *ChatViewController*

**@description:** 开放协议，将`ChatViewController.m`中的协议`<EaseMessageViewControllerDelegate, EaseMessageViewControllerDataSource>`，公开到`ChatViewController.h`中

```
//	修改后的.h文件
@interface ChatViewController : EaseMessageViewController <EaseMessageViewControllerDelegate, EaseMessageViewControllerDataSource>

```

#### Step4. 替换聊天窗口（ChatViewController）
**@description:** 替换*ChatViewController*为*RedPacketChatViewController（带有红包功能的聊天窗口）*
#### Step5. 检查红包按钮索引
**@Class:** *RedPacketChatViewController*

**@description:** 不同的App，聊天界面中更多功能列表页里的功能按钮数量可能不同，对应的位置也可能不同，所以要保证索引值正确。

**@Function:** 

*- (void)messageViewController:(EaseMessageViewController *)viewController didSelectMoreView:(EaseChatBarMoreView *)moreView AtIndex:(NSInteger)index*
```
/**
 *  红包单击事件索引
 */
static NSInteger const _redpacket_send_index   = 5;```#### Step6. 零钱页

**@Class:** *SettingsViewController*
**@description:**
'ChatDemoUI3.0'的零钱页放在了`SettingsViewController`页面里。 

通过`[RedpacketViewControl changeMoneyController]`获取零钱页。

#### Step7. 添加URLType
在info.plist文件中添加支付宝回调的URL Schemes alipayredpacket



####更多
* 环信红包是基于`环信 SDK2.2.5 ChatDemoUI3.0`开发的，以上介绍也是基于`环信 SDK2.2.5 ChatDemoUI3.0`，如果您的APP不依赖于环信`ChatDemoUI3.0`'的`ChatViewController`，或者不依赖于`EaseUI`，可以参考以上步骤自行实现红包功能。
* 红包的零钱页放在了`ChatDemoUI3.0`中的设置页面。
* 在pch文件中定义了REDPACKET_AVALABLE宏定义，可以通过宏定义开启关闭红包功能。
* 运行不通过，注意是否缺少支付宝的依赖库